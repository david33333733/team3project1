{% extends 'base.html' %}
{% load static %}

{% block title %}리뷰 목록{% endblock %}

{% block content %}
    <h1>리뷰 목록</h1>

    <div>
        <label for="book_id_filter">도서 ID로 검색:</label>
        <input type="number" id="book_id_filter" placeholder="도서 ID 입력">
        <button onclick="fetchReviewsByBook()">검색</button>
        <button onclick="fetchReviews()">모든 리뷰 보기</button>
    </div>

    <div id="review-list">
    </div>

    <div class="pagination">
        <span class="step-links">
            <button id="prev-page" disabled>이전</button>
            <span class="current-page">Page <span id="page-num">1</span> of <span id="total-pages">1</span></span>
            <button id="next-page">다음</button>
        </span>
    </div>

    <div id="edit-form-container" style="display:none;">
        <h2>리뷰 수정</h2>
        <form id="edit-review-form">
            <input type="hidden" id="edit-review-id" name="review_id">
            <input type="hidden" id="edit-review-username" name="username">
            <input type="hidden" id="edit-review-user" name="user_id">
            <input type="hidden" id="edit_book" name="book" required><br><br>
            <label for="edit_rating">평점 (1-5):</label>
            <input type="number" id="edit_rating" name="rating" min="1" max="5" required><br><br>
            <label for="edit_content">내용:</label>
            <textarea id="edit_content" name="content"></textarea><br><br>
            <button type="submit">리뷰 업데이트</button>
            <button type="button" onclick="cancelEdit()">취소</button>
        </form>
    </div>

    <script>
        let currentPage = 1;
        const reviewsPerPage = 10;

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        async function fetchReviews(page = 1) {
            const response = await fetch(`/api/reviews/?page=${page}`);
            const data = await response.json();
            const reviews = data.results;
            const reviewListDiv = document.getElementById('review-list');
            reviewListDiv.innerHTML = '';
            reviews.forEach(review => {
                reviewListDiv.innerHTML += `
                    <div id="review-${review.review_id}">
                        <p>ID: ${review.review_id}, 도서: ${review.book_title}</br><strong>${review.username}</strong> 평점: ${review.rating}, 내용: ${review.content}</p>
                        <button onclick="deleteReview(${review.review_id})">삭제</button>
                        <button onclick="showEditForm(${review.review_id}, ${review.book}, ${review.user_id}, '${review.username}',${review.rating}, '${review.content}')">수정</button>
                    </div>
                `;
            });

            const totalPages = Math.ceil(data.count / reviewsPerPage);
            document.getElementById('page-num').innerText = page;
            document.getElementById('total-pages').innerText = totalPages;

            document.getElementById('prev-page').disabled = !data.previous;
            document.getElementById('next-page').disabled = !data.next;
        }

        document.getElementById('prev-page').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                fetchReviews(currentPage);
            }
        });

        document.getElementById('next-page').addEventListener('click', () => {
            currentPage++;
            fetchReviews(currentPage);
        });

        async function fetchReviewsByBook() {
            const bookId = document.getElementById('book_id_filter').value;
            if (!bookId) {
                alert('검색할 도서 ID를 입력하세요.');
                return;
            }
            const response = await fetch(`/api/books/${bookId}/reviews/`);
            const reviews = await response.json();
            const reviewListDiv = document.getElementById('review-list');
            reviewListDiv.innerHTML = `<h2>도서 ID ${bookId}에 대한 리뷰</h2>`;
            if (reviews.length > 0) {
                reviews.forEach(review => {
                    reviewListDiv.innerHTML += `
                        <div id="review-${review.review_id}">
                            <p>ID: ${review.review_id}, 리뷰어: ${review.user}, 평점: ${review.rating}, 댓글: ${review.content}</p>
                            <button onclick="deleteReview(${review.review_id})">삭제</button>
                            <button onclick="showEditForm(${review.review_id}, ${review.book}, ${review.user}, ${review.rating}, '${review.content}')">수정</button>
                        </div>
                    `;
                });
            } else {
                reviewListDiv.innerHTML += '<p>이 도서에 대한 리뷰가 없습니다.</p>';
            }
        }

        async function deleteReview(reviewId) {
            const response = await fetch(`/api/reviews/${reviewId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrftoken
                }
            });
            if (response.ok) {
                alert('리뷰가 성공적으로 삭제되었습니다!');
                fetchReviews(currentPage);
            } else {
                alert('리뷰 삭제에 실패했습니다.');
            }
        }

        function showEditForm(reviewId, bookId, user, username, rating, content) {
            document.getElementById('edit-review-id').value = reviewId;
            document.getElementById('edit_book').value = bookId;
            document.getElementById('edit-review-user').value = user;
            document.getElementById('edit-review-username').value = username;
            document.getElementById('edit_rating').value = rating;
            document.getElementById('edit_content').value = content;
            document.getElementById('edit-form-container').style.display = 'block';
        }

        function cancelEdit() {
            document.getElementById('edit-form-container').style.display = 'none';
        }

        document.getElementById('edit-review-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const reviewId = document.getElementById('edit-review-id').value;
            const formData = new FormData(event.target);
            const reviewData = Object.fromEntries(formData.entries());
            console.log(reviewData);
            delete reviewData.review_id; 

            if (reviewData.book) reviewData.book = parseInt(reviewData.book);
            if (reviewData.rating) reviewData.rating = parseInt(reviewData.rating);
            if (reviewData.review_user_id) {
                reviewData.user = parseInt(reviewData.review_user_id);
                delete reviewData.review_user_id;
            }

            

            const response = await fetch(`/api/reviews/${reviewId}/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(reviewData)
            });

            if (response.ok) {
                alert('리뷰가 성공적으로 업데이트되었습니다!');
                cancelEdit();
                fetchReviews(currentPage);
            } else {
                alert('리뷰 업데이트에 실패했습니다.');
            }
        });

        fetchReviews(currentPage);
    </script>
{% endblock %}