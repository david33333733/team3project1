{% extends 'base.html' %}
{% load static %}

{% block title %}ë„ì„œ ëª©ë¡{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold mb-6 text-center">ğŸ“š ë„ì„œ ëª©ë¡</h1>

<!-- âœ… ë„ì„œ ê²€ìƒ‰ë°” (ë¡œê·¸ì¸ ì—¬ë¶€ ìƒê´€ì—†ì´ í•­ìƒ ë…¸ì¶œ) -->
<div class="mb-6 flex justify-center">
  <input 
    type="text" 
    id="search-input" 
    placeholder="ë„ì„œ ì œëª© ê²€ìƒ‰..." 
    class="w-full md:w-1/2 px-4 py-2 border rounded shadow focus:outline-none focus:ring-2 focus:ring-blue-300" />
</div>

{% if user.is_staff %}
  <div class="text-right mb-4">
    <button id="show-add-book-form-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">ë„ì„œ ì¶”ê°€</button>
  </div>
  <div id="add-book-form-container" class="bg-white p-6 rounded-lg shadow mb-6" style="display:none;">
    <h2 class="text-xl font-semibold mb-4">ìƒˆ ë„ì„œ ì¶”ê°€</h2>
    <form id="add-book-form" class="space-y-4">
      <div>
        <label for="title" class="block font-medium">ì œëª©</label>
        <input type="text" id="title" name="title" required class="w-full border rounded px-3 py-2">
      </div>
      <div>
        <label for="author" class="block font-medium">ì €ì</label>
        <select id="author" name="author" required class="w-full border rounded px-3 py-2"></select>
      </div>
      <div>
        <label for="publication_date" class="block font-medium">ì¶œíŒì¼</label>
        <input type="date" id="publication_date" name="publication_date" class="w-full border rounded px-3 py-2">
      </div>
      <div>
        <label for="description" class="block font-medium">ì„¤ëª…</label>
        <textarea id="description" name="description" class="w-full border rounded px-3 py-2"></textarea>
      </div>
      <div class="flex justify-end gap-2">
        <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">ë„ì„œ ì¶”ê°€</button>
        <button type="button" id="cancel-add-book-btn" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">ì·¨ì†Œ</button>
      </div>
    </form>
  </div>
{% endif %}

<div id="book-list" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
  <!-- ì±… ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤. -->
</div>

<div class="pagination mt-6 text-center">
  <span class="step-links flex items-center justify-center gap-4">
    <button id="prev-page" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300" disabled>ì´ì „</button>
    <span class="current-page text-sm">Page <span id="page-num">1</span> of <span id="total-pages">1</span></span>
    <button id="next-page" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">ë‹¤ìŒ</button>
  </span>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  let currentPage = 1;
  let currentSearch = "";
  const booksPerPage = 10;
  const currentUserId = {{ request.user.id|default:"null" }};

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  async function fetchBooks(page = 1, searchQuery = "") {
    const url = new URL(`/api/books/`, window.location.origin);
    url.searchParams.append("page", page);
    if (searchQuery) {
      url.searchParams.append("search", searchQuery);
    }

    const response = await fetch(url);
    const data = await response.json();
    const books = data.results;
    const bookListDiv = document.getElementById('book-list');
    bookListDiv.innerHTML = '';

    books.forEach(book => {
      const reviewsHtml = book.reviews.map(review =>
        `<p class="text-sm"><strong>${review.username ?? "ìµëª…"}</strong>: ${review.content}</p>`
      ).join('');

      const bookCard = `
        <div class="bg-white rounded-lg shadow-md p-6">
          <h3 class="text-xl font-bold mb-2 text-blue-700">
            <a href="/books/${book.book_id}/" class="hover:underline">${book.title}</a>
          </h3>
          <p class="text-sm text-gray-700 mb-2"><strong>ì €ì:</strong> ${book.author_name}</p>
          <div class="border-t pt-2">
            <h4 class="font-semibold mb-1">ìµœì‹  ë¦¬ë·°</h4>
            ${reviewsHtml || '<p class="text-gray-400 text-sm">ì•„ì§ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'}
          </div>
        </div>
      `;
      bookListDiv.innerHTML += bookCard;
    });

    const totalPages = Math.ceil(data.count / booksPerPage);
    document.getElementById('page-num').innerText = page;
    document.getElementById('total-pages').innerText = totalPages;

    document.getElementById('prev-page').disabled = !data.previous;
    document.getElementById('next-page').disabled = !data.next;
  }

  document.getElementById('prev-page').addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      fetchBooks(currentPage, currentSearch);
    }
  });

  document.getElementById('next-page').addEventListener('click', () => {
    currentPage++;
    fetchBooks(currentPage, currentSearch);
  });

  document.getElementById('search-input').addEventListener('input', () => {
    currentSearch = document.getElementById('search-input').value;
    currentPage = 1;
    fetchBooks(currentPage, currentSearch);
  });

  {% if user.is_staff %}
  document.getElementById('show-add-book-form-btn').addEventListener('click', () => {
    document.getElementById('add-book-form-container').style.display = 'block';
    document.getElementById('show-add-book-form-btn').style.display = 'none';
  });

  document.getElementById('cancel-add-book-btn').addEventListener('click', () => {
    document.getElementById('add-book-form-container').style.display = 'none';
    document.getElementById('show-add-book-form-btn').style.display = 'block';
    document.getElementById('add-book-form').reset();
  });

  const addBookForm = document.getElementById('add-book-form');
  if (addBookForm) {
    addBookForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const formData = new FormData(event.target);
      const publicationDate = formData.get('publication_date');
      const bookData = {
        title: formData.get('title'),
        author: formData.get('author'),
        description: formData.get('description'),
      };
      if (publicationDate) {
        bookData.publication_date = publicationDate;
      }

      const response = await fetch('/api/books/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(bookData)
      });
      if (response.ok) {
        alert('ë„ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
        fetchBooks(currentPage, currentSearch);
        event.target.reset();
        document.getElementById('add-book-form-container').style.display = 'none';
        document.getElementById('show-add-book-form-btn').style.display = 'block';
      } else {
        alert('ë„ì„œ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    });
  }

  async function fetchAuthorsForForm() {
    const response = await fetch('/api/authors/');
    const data = await response.json();
    const authors = data.results;
    const authorSelect = document.getElementById('author');
    authors.forEach(author => {
      const option = document.createElement('option');
      option.value = author.author_id;
      option.textContent = author.author_name;
      authorSelect.appendChild(option);
    });
  }

  fetchAuthorsForForm();
  {% endif %}

  fetchBooks(currentPage);
});
</script>
{% endblock %}
